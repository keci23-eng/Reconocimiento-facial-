{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cámara en vivo</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/login.css' %}">
  <link rel="icon" href="{% static 'images/logo.png' %}" type="image/png">
</head>

<body class="app-bg">

  <div class="page-wrap">
    <div class="container app-shell">

      <!-- TOPBAR -->
      <header class="topbar-pro">
        <div class="topbar-left">
          <div class="app-brand">
            <div class="logo">RF</div>
            <div>
              <div class="brand-title">Sistema de Acceso</div>
              <div class="breadcrumbs">
                <span>Guardia</span>
                <span class="crumb-sep">/</span>
                <span class="crumb-active">Cámara</span>
              </div>
            </div>
          </div>

          <div class="topbar-meta">
            <span class="chip chip-live">En vivo</span>
            <span class="chip chip-muted">Detección automática</span>
          </div>
        </div>

        <div class="topbar-actions">
          <a href="/guard/detections/" class="btn btn-outline-secondary btn-sm btn-soft">
            Detecciones
          </a>
          <a href="/logout/" class="btn btn-outline-secondary btn-sm btn-soft">
            Cerrar sesión
          </a>
        </div>
      </header>

      <!-- BANNER / INFO -->
      <section class="hero-strip">
        <div class="hero-copy">
          <div class="hero-title">Monitoreo en tiempo real</div>
          <div class="hero-sub">
            Mantén la cámara activa para registrar ingresos y asistencia.
          </div>
        </div>
        <div class="hero-stats">
          <div class="mini-stat">
            <div class="mini-stat-label">Estado</div>
            <div class="mini-stat-value">Activo</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-label">Detecciones</div>
            <div class="mini-stat-value" id="studentsCountTop">0</div>
          </div>
        </div>
      </section>

      <!-- CONTENIDO -->
      <main class="app-card app-card-pro">
        <div class="row g-4">

          <!-- CÁMARA -->
          <div class="col-lg-8">
            <section class="panel panel-pro">
              <div class="panel-head">
                <div>
                  <div class="panel-title">Cámara</div>
                  <div class="panel-sub">Vista en vivo con superposición de detección.</div>
                </div>
                <div class="panel-right">
                  <span class="pill">HD</span>
                  <span class="pill pill-live">LIVE</span>
                </div>
              </div>

              <div class="video-shell">
                <div class="video-topline"></div>
                <div class="video-wrapper">
                  <video id="video" autoplay muted playsinline></video>
                  <canvas id="overlay"></canvas>
                </div>
              </div>

              <div class="panel-foot">
                <span class="dot-live"></span>
                <span>Conectado</span>
                <span class="sep">•</span>
                <span class="muted">Ajusta la cámara para mejor detección</span>
              </div>
            </section>
          </div>

          <!-- LISTA -->
          <div class="col-lg-4">
            <section class="panel panel-pro">
              <div class="panel-head">
                <div>
                  <div class="panel-title">Estudiantes</div>
                  <div class="panel-sub">Detectados recientemente.</div>
                </div>
                <div class="panel-right">
                  <span class="count-pill" id="studentsCount">0</span>
                </div>
              </div>

              <div class="students-scroll list-pro">
                <ul id="studentsList" class="list-group"></ul>
              </div>

              <div class="panel-foot subtle">
                <span class="muted">Actualiza automáticamente</span>
              </div>
            </section>
          </div>

        </div>
      </main>

    </div>
  </div>

  <script src="{% static 'js/live.js' %}"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const video = document.getElementById('video');
      const overlay = document.getElementById('overlay');

      video?.addEventListener('loadedmetadata', () => {
        overlay.width = video.videoWidth || 640;
        overlay.height = video.videoHeight || 480;
      });

      // espejo opcional si tu cámara se ve “al revés”
      // video.style.transform = "scaleX(-1)";
    });

    // si tu live.js actualiza #studentsCount, aquí reflejamos arriba también
    const syncCount = () => {
      const c = document.getElementById('studentsCount')?.textContent ?? "0";
      const top = document.getElementById('studentsCountTop');
      if(top) top.textContent = c;
    };
    const obs = new MutationObserver(syncCount);
    const countEl = document.getElementById('studentsCount');
    if(countEl) obs.observe(countEl, { childList: true, characterData: true, subtree: true });
  </script>

</body>
</html>
