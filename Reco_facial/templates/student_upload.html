{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Registrar estudiante</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/login.css' %}">
  <link rel="icon" href="{% static 'images/logo.png' %}" type="image/png">
</head>

<body class="app-bg">

  <div class="page-wrap">
    <div class="container app-shell">

      <header class="topbar-pro">
        <div class="topbar-left">
          <div class="app-brand">
            <div class="logo">RF</div>
            <div>
              <div class="brand-title">Registro</div>
              <div class="breadcrumbs">
                <span>Estudiantes</span>
                <span class="crumb-sep">/</span>
                <span class="crumb-active">Nuevo</span>
              </div>
            </div>
          </div>

          <div class="topbar-meta">
            <span class="chip chip-muted">Alta con fotografía</span>
          </div>
        </div>

        <div class="topbar-actions">
          <a href="/app/" class="btn btn-outline-secondary btn-sm btn-soft">Volver</a>
          <a href="/logout/" class="btn btn-outline-danger btn-sm btn-soft">Cerrar sesión</a>
        </div>
      </header>

      <section class="hero-strip">
        <div class="hero-copy">
          <div class="hero-title">Registrar estudiante</div>
          <div class="hero-sub">Completa los datos y sube una foto nítida del rostro.</div>
        </div>

        <div class="hero-stats">
          <div class="mini-stat">
            <div class="mini-stat-label">Recomendación</div>
            <div class="mini-stat-value">Buena iluminación</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-label">Formato</div>
            <div class="mini-stat-value">JPG / PNG</div>
          </div>
        </div>
      </section>

      <main class="app-card app-card-pro">
        <div class="row g-4">

          <div class="col-lg-5">
            <section class="panel panel-pro">
              <div class="panel-head">
                <div>
                  <div class="panel-title">Vista previa</div>
                  <div class="panel-sub">Verifica la foto antes de enviar.</div>
                </div>
                <div class="panel-right">
                  <span class="pill" id="fileMeta">Sin archivo</span>
                </div>
              </div>

              <div class="panel-body">
                <div class="preview-pro" id="dropZone" role="button" tabindex="0" aria-label="Zona de subida de imagen">
                  <div class="preview-placeholder" id="previewPlaceholder">
                    <div class="preview-title">Arrastra una imagen aquí</div>
                    <div class="preview-sub">o selecciona un archivo desde tu equipo</div>
                  </div>
                  <img id="previewImg" alt="Vista previa" class="preview-img">
                </div>

                <div class="note-box mt-3">
                  Usa una foto de frente, sin filtros, con el rostro centrado.
                </div>
              </div>
            </section>
          </div>

          <div class="col-lg-7">
            <section class="panel panel-pro">
              <div class="panel-head">
                <div>
                  <div class="panel-title">Datos del estudiante</div>
                  <div class="panel-sub">Los campos marcados son obligatorios.</div>
                </div>
              </div>

              <div class="panel-body">
                <form id="uploadForm" action="/api/register/" method="post" enctype="multipart/form-data" novalidate>
                  <div class="row g-3">

                    <div class="col-md-6">
                      <label class="form-label">Nombre completo</label>
                      <input name="name" class="form-control" placeholder="Ej: Juan Pérez" required>
                      <div class="form-text">Nombre y apellido.</div>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Carrera</label>
                      <input name="career" class="form-control" value="SISTEMAS Y GESTION DE DATA" required>
                      <div class="form-text">Modifica si aplica.</div>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Correo (opcional)</label>
                      <input name="correo" type="email" class="form-control" placeholder="correo@ejemplo.com">
                      <div class="form-text">Correo del estudiante (opcional).</div>
                    </div>

                    <div class="col-12">
                      <label class="form-label">Imagen del rostro</label>
                      <input id="imageFile" name="image" type="file" accept="image/*" class="form-control" required>
                      <div class="form-text">Evita fotos borrosas, oscuras o con gafas que tapen el rostro.</div>
                    </div>

                    <div class="col-12">
                      <div class="status-pro" id="uploadStatus" aria-live="polite">
                        Listo para subir una imagen.
                      </div>
                    </div>

                    <div class="col-12 d-flex flex-column flex-sm-row gap-2">
                      <button id="submitBtn" type="submit" class="btn btn-primary-custom flex-fill">
                        Subir y registrar
                      </button>
                      <button id="clearBtn" type="button" class="btn btn-outline-secondary btn-soft flex-fill">
                        Limpiar
                      </button>
                    </div>

                  </div>
                </form>
              </div>
            </section>
          </div>

        </div>
      </main>

    </div>
  </div>

  <script>
    const form = document.getElementById('uploadForm');
    const statusEl = document.getElementById('uploadStatus');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');

    const imageFile = document.getElementById('imageFile');
    const previewImg = document.getElementById('previewImg');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    const dropZone = document.getElementById('dropZone');
    const fileMeta = document.getElementById('fileMeta');

    function setStatus(type, msg){
      statusEl.classList.remove('is-ok','is-warn','is-bad','is-busy');
      if(type) statusEl.classList.add(type);
      statusEl.textContent = msg;
    }

    function setBusy(busy){
      submitBtn.disabled = busy;
      submitBtn.textContent = busy ? 'Enviando…' : 'Subir y registrar';
      if(busy) setStatus('is-busy', 'Enviando imagen…');
    }

    function getCookie(name){
      const match = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return match ? match.pop() : '';
    }

    function resetPreview(){
      previewImg.removeAttribute('src');
      previewImg.classList.remove('show');
      previewPlaceholder.style.display = 'grid';
      fileMeta.textContent = 'Sin archivo';
      setStatus('', 'Listo para subir una imagen.');
      dropZone.classList.remove('has-file');
    }

    function setPreview(file){
      if(!file){
        resetPreview();
        return;
      }
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      previewImg.classList.add('show');
      previewPlaceholder.style.display = 'none';
      dropZone.classList.add('has-file');

      const kb = Math.round(file.size / 1024);
      fileMeta.textContent = `${file.type.split('/')[1]?.toUpperCase() || 'IMG'} · ${kb} KB`;

      setStatus('is-warn', 'Imagen seleccionada. Revisa la vista previa y envía el registro.');
    }

    imageFile.addEventListener('change', () => {
      const file = imageFile.files && imageFile.files[0];
      setPreview(file);
    });

    dropZone.addEventListener('click', () => imageFile.click());
    dropZone.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' ') imageFile.click();
    });

    ['dragenter','dragover'].forEach(evt => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add('dragover');
      });
    });

    ['dragleave','drop'].forEach(evt => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('dragover');
      });
    });

    dropZone.addEventListener('drop', (e) => {
      const file = e.dataTransfer?.files?.[0];
      if(!file) return;
      if(!file.type.startsWith('image/')){
        setStatus('is-bad', 'Selecciona un archivo de imagen válido.');
        return;
      }
      imageFile.files = e.dataTransfer.files;
      setPreview(file);
    });

    clearBtn.addEventListener('click', () => {
      form.reset();
      resetPreview();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const file = imageFile.files && imageFile.files[0];
      if(!file){
        setStatus('is-bad', 'Selecciona una imagen antes de enviar.');
        return;
      }

      setBusy(true);

      const fd = new FormData(form);
      try{ fd.append('client_timestamp', new Date().toISOString()); }catch(_){}

      try{
        const headers = {};
        const csrftoken = getCookie('csrftoken');
        if(csrftoken) headers['X-CSRFToken'] = csrftoken;

        const resp = await fetch(form.action, {
          method: 'POST',
          body: fd,
          credentials: 'same-origin',
          headers
        });

        const text = await resp.text();
        let data = null;
        try { data = JSON.parse(text); } catch(_) {}

        if(resp.status === 201){
          setStatus('is-ok', 'Registro completado correctamente.');
          form.reset();
          resetPreview();
        }else{
          const msg = (data && data.error) ? data.error : (text || `HTTP ${resp.status}`);
          setStatus('is-bad', 'Error: ' + msg);
        }
      }catch(err){
        setStatus('is-bad', 'Error de red: ' + (err && err.message ? err.message : err));
      }finally{
        setBusy(false);
      }
    });

    resetPreview();
  </script>

</body>
</html>
